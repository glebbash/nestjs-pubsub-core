import { DynamicModule, Module } from '@nestjs/common';
import { ClientConfig, PubSub, SubscriptionOptions } from '@google-cloud/pubsub';
import { getSubscriptionToken, getTopicToken } from '../nestjs-pubsub-core';
import { PublishOptions } from '@google-cloud/pubsub/build/src/publisher';
import { PubSubService } from './pubsub.service';
import { Token } from '../utils/token';
import { AsyncSettings, SettingsProvider } from '../utils/settings-provider';
import { credentials } from '@grpc/grpc-js';
import { PubSubPublisherSettings } from '../pubsub-publisher/pubsub-publisher.module';

export const PubSubSettings = Symbol('PubSubSettings');
export type PubSubSettings = PubSubInstanceOrSettings & {
  topics: Record<Token, TopicSettings>;
  /**
   * By default the pubsub instance is closed on module destroy.
   * You can disable this behavior by setting this to false.
   */
  closeOnModuleDestroy?: false;
};

export type PubSubInstanceOrSettings =
  | {
      pubSub: PubSub;
      pubSubSettings?: undefined;
    }
  | {
      pubSub?: undefined;
      pubSubSettings: PubSubClientSettings;
    };

/**
 * If emulatorPort is provided this fields are set:
 *   servicePath: 'localhost',
 *   port: emulatorPort,
 *   sslCreds: credentials.createInsecure(),
 */
export type PubSubClientSettings = { emulatorPort?: number } & ClientConfig;

export const getClientConfig = (settings: PubSubClientSettings): ClientConfig | undefined => {
  const { emulatorPort, ...config } = settings;

  return emulatorPort
    ? {
        servicePath: 'localhost',
        port: emulatorPort,
        sslCreds: credentials.createInsecure(),
        ...config,
      }
    : config;
};

export const pubSubFactory = (settings: PubSubSettings): PubSub =>
  settings.pubSub ?? new PubSub(getClientConfig(settings.pubSubSettings));

export type TopicSettings = {
  name: string;
  options?: PublishOptions;
  subscriptions?: Record<Token, SubscriptionSettings>;
};

export type SubscriptionSettings = {
  name: string;
  options?: SubscriptionOptions;
};

export type PubSubFeatureSettings = {
  topics?: Token[];
  subscriptions?: Token[];
};

@Module({})
export class PubSubModule {
  static forRoot(settings: PubSubSettings): DynamicModule {
    return PubSubModule.forRootAsync({ useValue: settings });
  }

  static forRootAsync(settings: AsyncSettings<PubSubSettings>): DynamicModule {
    return {
      module: PubSubModule,
      global: true,
      providers: [
        <SettingsProvider<PubSubPublisherSettings>>{
          provide: PubSubPublisherSettings,
          ...settings,
        },
        <SettingsProvider<PubSubSettings>>{
          provide: PubSubSettings,
          ...settings,
        },
        {
          provide: PubSub,
          inject: [PubSubSettings],
          useFactory: pubSubFactory,
        },
        {
          provide: PubSubService,
          inject: [PubSub, PubSubSettings, PubSubPublisherSettings],
          useFactory: (
            pubSub: PubSub,
            settings: PubSubSettings,
            timeoutMillis: PubSubPublisherSettings
          ) => new PubSubService(pubSub, settings, timeoutMillis),
        },
      ],
      exports: [PubSubService],
    };
  }

  static forFeature(settings: PubSubFeatureSettings): DynamicModule {
    const providers = [
      ...(settings.topics ?? []).map((topic) => ({
        provide: getTopicToken(topic),
        inject: [PubSubService],
        useFactory: (service: PubSubService) => service.getTopic(topic),
      })),
      ...(settings.subscriptions ?? []).map((subscription) => ({
        provide: getSubscriptionToken(subscription),
        inject: [PubSubService],
        useFactory: (service: PubSubService) => service.getSubscription(subscription),
      })),
    ];

    return {
      module: PubSubModule,
      providers: providers,
      exports: providers,
    };
  }
}
